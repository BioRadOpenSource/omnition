#!/usr/bin/env Rscript

suppressPackageStartupMessages(library(argparse))
suppressPackageStartupMessages(library(Matrix))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(dplyr))

parser <- ArgumentParser()

parser$add_argument("countsFile", nargs = 1,
                    help = "Path to counts.tsv.gz generated by UMI Tools.")
parser$add_argument(
  "-w",
  "--allowlist",
  type = "character",
  default = "NULL",
  #nolint start
  help = "Path to a barcode allowlist. If NULL, output matrix includes all cells. [Default: NULL]"
  #nolint end
)
parser$add_argument(
  "-o",
  "--output_directory",
  type = "character",
  default = getwd(),
  help = "Directory to write output files. [Default: Current working directory]"
)
parser$add_argument("-g",
                    "--genes",
                    type = "character",
                    default = "NULL",
                    help = "Headerless text file of all gene symbols. [Default: NULL]")
parser$add_argument("-p",
                    "--prefix",
                    type = "character",
                    default = "alignments",
                    help = "Prefix for filenames. [Default: alignments]")
parser$add_argument("-m",
                    "--mixed",
                    type = "character",
                    default = "NULL",
                    #nolint start
                    help = "Check if script should be used for mixed expression. [Default: NULL]"
                    #nolint end
                    )


parser <- parser$parse_args()

countsFile <- parser$countsFile
outDir <- parser$output_directory
allowlist <- parser$allowlist
prefix <- parser$prefix
all_genes <- parser$genes
mixed_expression <- parser$mixed

# Set data.table threading
setDTthreads()

###begin processing

df <- fread(countsFile)

if (!allowlist == "NULL") {
  allowlist <- fread(allowlist, header = F)
  df <- df[df$cell %in% allowlist$V1]
}

if (!all_genes == "NULL") {
  genes <- fread(all_genes, header = F)
  genesColCheck <- genes$V1
  genesBothNames <- paste(genes$V1, genes$V2, sep = "\t")
} else {
  genesColCheck <- unique(df$gene)
  genesBothNames <- unique(df$gene)
}

barcodes <- unique(df$cell)

df$geneIdx <- match(df$gene, genesColCheck)
df$cellIdx <- match(df$cell, barcodes)
if (!mixed_expression == "NULL") {
  df <- df %>% filter(!is.na(geneIdx))
}

mat <- Matrix::sparseMatrix(
  i = df$geneIdx,
  j = df$cellIdx,
  x = df$count,
  dims = c(length(genesBothNames), length(barcodes))
)

if (max(mat) <= 1) {
  write("Binary count matrix produced; exiting.", stderr())
  quit(save = "no", status = 1)
}

writeMM(mat, file = paste0(outDir, "/", prefix, ".mtx"))
fwrite(
  as.list(barcodes),
  file = paste0(outDir, "/", prefix, ".barcodes.tsv"),
  sep = "\n"
)
fwrite(
  as.list(genesBothNames),
  file = paste0(outDir, "/", prefix, ".genes.tsv"),
  sep = "\n"
)
